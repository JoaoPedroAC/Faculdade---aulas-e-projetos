CONNECT scott/tiger@//localhost:1521/FREEPDB1 -- dentro do sql plus

SET SERVEROUTPU ON

CREATE OR REPLACE TRIGGER RESTRINGE_SALARIO
BEFORE INSERT OR UPDATE OF SAL ON EMP -- MONITORAMENTO ANTES DA OCORRENCIA DO EVENTO (DEPOIS DO BEFORE)
FOR EACH ROW
BEGIN
	IF NOT (:NEW.JOB IN('PRESIDENT', 'SALE')) AND :NEW.SAL > 15000 THEN
		RAISE_APPLICATION_ERROR(-20202, 'O FUNCIONARIO NAO PODE TER ESTE AUMENTO DE SALARIO');
	END IF;
END;
/

TESTANDO O GATILHO

INSERT INTO EMP(EMPNO, ENAME, JOB, SAL, DEPTNO) VALUES (135, 'MARCOS', 'CLERK', 15010, 10); --ATIVA
INSERT INTO EMP(EMPNO, ENAME, JOB, SAL, DEPTNO) VALUES (135, 'MARCOS', 'SALES, 15010, 10); --NÃO ATIVA

SELECT * FROM EMP WHERE EMPNO = 135;

----------------------------------------
FAZENDO UMA AUDITORIA

CREATE TABLE AUD_EMP(
USER_NAME VARCHAR2(30),
DATA DATE,
ANTIGO_NOME VARCHAR2(30),
NOVO_NOME VARCHAR2(30),
ANTIGO_SALARIO NUMBER(7,2),
NOVO_SALARIO NUMBER(7,2));


CREATE OR REPLACE TRIGGER AUDITAR_EMP
AFTER DELETE OR INSERT OR UPDATE ON SCOTT.EMP
FOR EACH ROW
BEGIN
	INSERT INTO AUD_EMP(USER_NAME, DATA, ANTIGO_NOME, NOVO_NOME, ANTIGO_SALARIO, NOVO_SALARIO)
	VALUES (USER, SYSDATE, :OLD_ENAME, :NEW.ENAME, :OLD.SAL, :NEW.SAL); -- OS : SIGNIFICA QUE É UMA VARIAVEL DE AMBIENTE E NÃO DO BLOCO
END;
/

TESTANDO GATILHO

INSERT INTO SCOTT.EMP(EMPNO, ENAME, SAL, DEPTNO) VALUES (7939, 'SANDRA', 1203, 10);

SELECT USER_NAME, TO_CHAR(DATA, 'dd/mm/yyyy-HH:mi:ss'), ANTIGO_NOME, NOVO_NOME, ANTIGO_SALARIO, NOVO_SALARIO FROM AUD_EMP;

UPDATE SCOTT.EMP
SET SAL = 1300
WHERE ENAME = 'SANDRA';

SET LINESIZE 200; --DEFINE O TAMANHO DO ESPAÇO IMPRESSO

ELECT USER_NAME, TO_CHAR(DATA, 'dd/mm/yyyy-HH:mi:ss'), ANTIGO_NOME, NOVO_NOME, ANTIGO_SALARIO, NOVO_SALARIO FROM AUD_EMP;

---------------------------------------------------
ORDEM DE DISPARO

CONN SYSTEM/0102

ALTER SESSION SET CONTAINER = 'FREEPDB1';

SET SERVEROUTPUT ON;

DROP TABLE EMPREGADO;
DROP TABLE FUNCIONARIO;

CREATE TABLE EMPREGADO AS (SELECT * FROM SCOTT.EMP);

CREATE OR REPLACE TRIGGER VIGIA
AFTER RENAME ON SCHEMA
BEGIN
	DBMS_OUTPUT.PUT_LINE('ALGO MUDOU DE NOME');
END;
/

RENAME EMPREGADO OF FUNCIONARIO;

------------------------------------------------------------
ORDEM DE DISPARO DDL

CONN SYSTEM/0102

ALTER SESSION SET CONTAINER = 'FREEPDB1';

SET SERVEROUTPUT ON;

DROP TABLE EMPREGADO;
DROP TABLE FUNCIONARIO;

CREATE TABLE EMPREGADO AS (SELECT * FROM SCOTT.EMP);

CREATE OR REPLACE TRIGGER VIGIA2
AFTER RENAME ON SCHEMA
BEGIN
	DBMS_OUTPUT.PUT_LINE('O Comando' || ORA_SYSEVENT || ' acima foi executado pelo usuario ' || ORA_LOGIN_USER || ' em objeto criado pelo usuario ' || ORA_DICT_OBJ_OWNER || ' no objeto: ' || ORA_DICT_OBJ_NAME);
END;
/

RENAME EMPREGADO OF FUNCIONARIO;















